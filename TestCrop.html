<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ í¬ë¡­ í…ŒìŠ¤íŠ¸</title>
    <style>
        :root {
            --accent-color: #8a6bff;
            --accent-secondary: #6f5acf;
            --border-radius: 12px;
            --bg-color: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #3a3a3a;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .upload-section, .preview-section {
            padding: 20px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
        }

        h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .upload-box {
            height: 300px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .preview-box {
            height: 300px;
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .preview-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-crop-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .original-image {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
        }

        .crop-box {
            position: absolute;
            border: 3px dashed var(--accent-color);
            background-color: rgba(255, 255, 255, 0.15);
            pointer-events: all;
            z-index: 10;
            border-radius: var(--border-radius);
            cursor: move;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .crop-handle {
            position: absolute;
            width: 18px;
            height: 18px;
            background-color: var(--accent-color);
            border: 2px solid white;
            border-radius: 50%;
            z-index: 20;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .handle-nw {
            top: -9px;
            left: -9px;
            cursor: nw-resize;
        }
        .handle-ne {
            top: -9px;
            right: -9px;
            cursor: ne-resize;
        }
        .handle-sw {
            bottom: -9px;
            left: -9px;
            cursor: sw-resize;
        }
        .handle-se {
            bottom: -9px;
            right: -9px;
            cursor: se-resize;
        }

        .handle-n {
            top: -9px;
            left: 50%;
            transform: translateX(-50%);
            cursor: n-resize;
        }
        .handle-e {
            top: 50%;
            right: -9px;
            transform: translateY(-50%);
            cursor: e-resize;
        }
        .handle-s {
            bottom: -9px;
            left: 50%;
            transform: translateX(-50%);
            cursor: s-resize;
        }
        .handle-w {
            top: 50%;
            left: -9px;
            transform: translateY(-50%);
            cursor: w-resize;
        }

        .apply-crop-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 20;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .apply-crop-btn:hover {
            background-color: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        input[type="file"] {
            display: none;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: var(--accent-secondary);
        }

        .console-log {
            margin-top: 20px;
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: var(--border-radius);
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì´ë¯¸ì§€ í¬ë¡­ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-area">
            <div class="upload-section">
                <h2>ì´ë¯¸ì§€ ì—…ë¡œë“œ & í¬ë¡­</h2>
                <div class="upload-box" id="upload-box">
                    <div class="upload-placeholder" id="upload-placeholder">
                        <div class="upload-icon">ğŸ“·</div>
                        <p>ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                    </div>
                    <input type="file" id="file-input" accept="image/*">
                </div>
                <button id="upload-btn">ì´ë¯¸ì§€ ì„ íƒ</button>
            </div>
            
            <div class="preview-section">
                <h2>í¬ë¡­ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h2>
                <div class="preview-box" id="preview-box"></div>
            </div>
        </div>
        
        <div class="console-log" id="console-log">ë¡œê·¸ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let originalImage = null;
        let cropperActive = false;
        let cropStartX = 0;
        let cropStartY = 0;
        let cropBox = null;
        let imageContainer = null;

        // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
        function log(message) {
            const consoleLog = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.innerHTML += `[${timestamp}] ${message}\n`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
            console.log(message);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBox = document.getElementById('upload-box');
            const fileInput = document.getElementById('file-input');
            const uploadBtn = document.getElementById('upload-btn');
            
            // ì—…ë¡œë“œ ë°•ìŠ¤ í´ë¦­ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜
            const uploadBoxClickHandler = function() {
                fileInput.click();
            };
            
            // ì—…ë¡œë“œ ë°•ìŠ¤ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            uploadBox.addEventListener('click', uploadBoxClickHandler);
            
            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function(event) {
                handleFileSelect(event);
                
                // ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ë©´ ì—…ë¡œë“œ ë°•ìŠ¤ì˜ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                uploadBox.removeEventListener('click', uploadBoxClickHandler);
            });
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadBox.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadBox.addEventListener(eventName, function() {
                    uploadBox.style.borderColor = 'var(--accent-color)';
                    uploadBox.style.backgroundColor = 'var(--bg-tertiary)';
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadBox.addEventListener(eventName, function() {
                    uploadBox.style.borderColor = 'var(--border-color)';
                    uploadBox.style.backgroundColor = 'var(--bg-secondary)';
                }, false);
            });
            
            uploadBox.addEventListener('drop', function(e) {
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleFile(file);
                    
                    // ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ë©´ ì—…ë¡œë“œ ë°•ìŠ¤ì˜ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                    uploadBox.removeEventListener('click', uploadBoxClickHandler);
                }
            }, false);
        });

        // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        }

        // íŒŒì¼ ì²˜ë¦¬
        function handleFile(file) {
            log(`ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒë¨: ${file.name}`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage = e.target.result;
                log('ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ, í¬ë¡­í¼ ì„¤ì • ì‹œì‘');
                setupImageCropper(originalImage);
                
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ! ì´ì œ í¬ë¡­ ì˜ì—­ì„ ì¡°ì ˆí•˜ê±°ë‚˜ ìƒˆë¡œ ê·¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsDataURL(file);
        }

        // ì´ë¯¸ì§€ í¬ë¡­í¼ ì„¤ì •
        function setupImageCropper(imageURL) {
            log('setupImageCropper í˜¸ì¶œë¨');
            
            const uploadBox = document.getElementById('upload-box');
            const placeholder = document.getElementById('upload-placeholder');
            
            log(`ì—…ë¡œë“œ ë°•ìŠ¤: ${uploadBox ? 'ì°¾ìŒ' : 'ëª»ì°¾ìŒ'}`);
            log(`í”Œë ˆì´ìŠ¤í™€ë”: ${placeholder ? 'ì°¾ìŒ' : 'ëª»ì°¾ìŒ'}`);
            
            if (uploadBox && placeholder) {
                // í”Œë ˆì´ìŠ¤í™€ë” ìˆ¨ê¸°ê¸°
                placeholder.style.display = 'none';
                
                // ì—…ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                const uploadBtn = document.getElementById('upload-btn');
                if (uploadBtn) {
                    uploadBtn.style.display = 'none';
                }
                
                // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìƒì„±
                if (!imageContainer) {
                    log('ìƒˆ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìƒì„±');
                    imageContainer = document.createElement('div');
                    imageContainer.className = 'image-crop-container';
                    imageContainer.style.position = 'relative';
                    imageContainer.style.width = '100%';
                    imageContainer.style.height = '100%';
                    imageContainer.style.overflow = 'hidden';
                    uploadBox.appendChild(imageContainer);
                } else {
                    log('ê¸°ì¡´ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ì¬ì‚¬ìš©');
                    imageContainer.innerHTML = '';
                }
                
                // ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„±
                const img = document.createElement('img');
                img.src = imageURL;
                img.className = 'original-image';
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.display = 'block';
                img.style.margin = '0 auto';
                
                // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ í›„ í¬ë¡­ ê¸°ëŠ¥ ì„¤ì •
                img.onload = function() {
                    log('ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ, DOMì— ì¶”ê°€');
                    imageContainer.appendChild(img);
                    
                    // ì´ë¯¸ì§€ ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    setTimeout(() => {
                        const imgRect = img.getBoundingClientRect();
                        const containerRect = imageContainer.getBoundingClientRect();
                        
                        // ì´ë¯¸ì§€ ìœ„ì¹˜ ìƒëŒ€ ê³„ì‚°
                        const imgLeft = imgRect.left - containerRect.left;
                        const imgTop = imgRect.top - containerRect.top;
                        const imgWidth = imgRect.width;
                        const imgHeight = imgRect.height;
                        
                        log(`ì´ë¯¸ì§€ ì •ë³´: left=${imgLeft}, top=${imgTop}, width=${imgWidth}, height=${imgHeight}`);
                        
                        // ì „ì²´ ì´ë¯¸ì§€ë¥¼ í¬í•¨í•˜ëŠ” ì´ˆê¸° í¬ë¡­ ì˜ì—­ ìƒì„±
                        createInitialCropBox(imgLeft, imgTop, imgWidth, imgHeight);
                        
                        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆì— ìƒˆë¡œìš´ í¬ë¡­ ì˜ì—­ ì„ íƒì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                        setupCropEvents();
                        
                        // ì´ˆê¸° í”„ë¦¬ë·° ì—…ë°ì´íŠ¸ (ì „ì²´ ì´ë¯¸ì§€)
                        updatePreview(imageURL);
                    }, 100);
                };
            } else {
                log('ì˜¤ë¥˜: ì—…ë¡œë“œ ë°•ìŠ¤ ë˜ëŠ” í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        }

        // ì´ˆê¸° í¬ë¡­ ë°•ìŠ¤ ìƒì„± (ì „ì²´ ì´ë¯¸ì§€ í¬ê¸°)
        function createInitialCropBox(left, top, width, height) {
            log('ì´ˆê¸° í¬ë¡­ ë°•ìŠ¤ ìƒì„±');
            
            // ê¸°ì¡´ í¬ë¡­ ë°•ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
            if (cropBox) {
                cropBox.remove();
                cropBox = null;
            }
            
            // í¬ë¡­ ë°•ìŠ¤ ìƒì„±
            cropBox = document.createElement('div');
            cropBox.className = 'crop-box';
            cropBox.style.position = 'absolute';
            cropBox.style.border = '3px dashed var(--accent-color)';
            cropBox.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
            cropBox.style.left = left + 'px';
            cropBox.style.top = top + 'px';
            cropBox.style.width = width + 'px';
            cropBox.style.height = height + 'px';
            cropBox.style.borderRadius = 'var(--border-radius)';
            cropBox.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.3)';
            
            imageContainer.appendChild(cropBox);
            
            // í¬ë¡­ í•¸ë“¤ ì¶”ê°€
            addCropHandles(cropBox);
            
            // í¬ë¡­ ë°•ìŠ¤ì— ì´ë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            cropBox.addEventListener('mousedown', startMove);
            
            // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateCropPreview();
            }, 100);
            
            // ì ìš© ë²„íŠ¼ í‘œì‹œ
            showApplyButton();
        }

        // í¬ë¡­ í•¸ë“¤ ì¶”ê°€
        function addCropHandles(cropBox) {
            log('í¬ë¡­ í•¸ë“¤ ì¶”ê°€');
            
            // 8ê°œì˜ í•¸ë“¤ ìƒì„± (4 ëª¨ì„œë¦¬ + 4 ë³€)
            const handlePositions = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
            
            handlePositions.forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `crop-handle handle-${pos}`;
                handle.setAttribute('data-position', pos);
                cropBox.appendChild(handle);
                
                // í•¸ë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                handle.addEventListener('mousedown', startResize);
            });
            
            // í¬ë¡­ ë°•ìŠ¤ì— ì´ë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            cropBox.addEventListener('mousedown', startMove);
        }

        // í¬ë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupCropEvents() {
            log('setupCropEvents í˜¸ì¶œë¨');
            
            if (!imageContainer) {
                log('ì˜¤ë¥˜: ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆì— mousedown ì´ë²¤íŠ¸ ì¶”ê°€ (ìƒˆë¡œìš´ ì„ íƒ ì‹œì‘ìš©)
            imageContainer.addEventListener('mousedown', function(e) {
                // ì´ë²¤íŠ¸ê°€ í¬ë¡­ ë°•ìŠ¤ë‚˜ í•¸ë“¤ì—ì„œ ì‹œì‘ëœ ê²½ìš°ëŠ” ë¬´ì‹œ
                if (e.target !== imageContainer && e.target !== imageContainer.querySelector('img')) {
                    return;
                }
                
                // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€
                e.preventDefault();
                e.stopPropagation();
                
                startCrop(e);
            });
            
            // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆì˜ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ì¤‘ì§€ - íŒŒì¼ ì—…ë¡œë“œ íŠ¸ë¦¬ê±° ë°©ì§€
            imageContainer.addEventListener('click', function(e) {
                if (e.target === imageContainer || e.target === imageContainer.querySelector('img') || 
                    e.target === cropBox || e.target.classList.contains('crop-handle')) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }

        // í•¸ë“¤ë¡œ í¬ê¸° ì¡°ì ˆ ì‹œì‘
        function startResize(e) {
            e.preventDefault();
            e.stopPropagation();
            log('í¬ê¸° ì¡°ì ˆ ì‹œì‘');
            
            const handle = e.target;
            const position = handle.getAttribute('data-position');
            
            // í˜„ì¬ ìƒíƒœ ì €ì¥
            const initialCropBoxRect = cropBox.getBoundingClientRect();
            const initialMouseX = e.clientX;
            const initialMouseY = e.clientY;
            
            // í˜„ì¬ í¬ë¡­ ë°•ìŠ¤ ìœ„ì¹˜ ë° í¬ê¸°
            const initialLeft = parseInt(cropBox.style.left);
            const initialTop = parseInt(cropBox.style.top);
            const initialWidth = parseInt(cropBox.style.width);
            const initialHeight = parseInt(cropBox.style.height);
            
            // ì´ë™ í•¨ìˆ˜
            function handleResize(moveEvent) {
                const deltaX = moveEvent.clientX - initialMouseX;
                const deltaY = moveEvent.clientY - initialMouseY;
                
                const containerRect = imageContainer.getBoundingClientRect();
                const imgRect = imageContainer.querySelector('img').getBoundingClientRect();
                
                // ì´ë¯¸ì§€ ë‚´ë¶€ ìœ„ì¹˜ ê³„ì‚°
                const imgLeft = imgRect.left - containerRect.left;
                const imgTop = imgRect.top - containerRect.top;
                const imgRight = imgLeft + imgRect.width;
                const imgBottom = imgTop + imgRect.height;
                
                // ìƒˆë¡œìš´ í¬ë¡­ ë°•ìŠ¤ ìœ„ì¹˜ ë° í¬ê¸°
                let newLeft = initialLeft;
                let newTop = initialTop;
                let newWidth = initialWidth;
                let newHeight = initialHeight;
                
                // ìµœì†Œ í¬ê¸°
                const MIN_SIZE = 20;
                
                // ìœ„ì¹˜ì— ë”°ë¼ ë‹¤ë¥¸ ì²˜ë¦¬
                switch (position) {
                    case 'nw': // ì¢Œìƒë‹¨
                        // ë„ˆë¹„ ë³€ê²½ (ì™¼ìª½ ë³€ê²½)
                        newLeft = Math.max(imgLeft, Math.min(initialLeft + deltaX, initialLeft + initialWidth - MIN_SIZE));
                        newWidth = initialWidth - (newLeft - initialLeft);
                        
                        // ë†’ì´ ë³€ê²½ (ìœ„ìª½ ë³€ê²½)
                        newTop = Math.max(imgTop, Math.min(initialTop + deltaY, initialTop + initialHeight - MIN_SIZE));
                        newHeight = initialHeight - (newTop - initialTop);
                        break;
                        
                    case 'n': // ìƒë‹¨ ì¤‘ì•™
                        // ë†’ì´ë§Œ ë³€ê²½ (ìœ„ìª½)
                        newTop = Math.max(imgTop, Math.min(initialTop + deltaY, initialTop + initialHeight - MIN_SIZE));
                        newHeight = initialHeight - (newTop - initialTop);
                        break;
                        
                    case 'ne': // ìš°ìƒë‹¨
                        // ë„ˆë¹„ ë³€ê²½ (ì˜¤ë¥¸ìª½ ë³€ê²½)
                        newWidth = Math.max(MIN_SIZE, Math.min(initialWidth + deltaX, imgRight - initialLeft));
                        
                        // ë†’ì´ ë³€ê²½ (ìœ„ìª½ ë³€ê²½)
                        newTop = Math.max(imgTop, Math.min(initialTop + deltaY, initialTop + initialHeight - MIN_SIZE));
                        newHeight = initialHeight - (newTop - initialTop);
                        break;
                        
                    case 'e': // ìš°ì¸¡ ì¤‘ì•™
                        // ë„ˆë¹„ë§Œ ë³€ê²½ (ì˜¤ë¥¸ìª½)
                        newWidth = Math.max(MIN_SIZE, Math.min(initialWidth + deltaX, imgRight - initialLeft));
                        break;
                        
                    case 'se': // ìš°í•˜ë‹¨
                        // ë„ˆë¹„ ë³€ê²½ (ì˜¤ë¥¸ìª½ ë³€ê²½)
                        newWidth = Math.max(MIN_SIZE, Math.min(initialWidth + deltaX, imgRight - initialLeft));
                        
                        // ë†’ì´ ë³€ê²½ (ì•„ë˜ìª½ ë³€ê²½)
                        newHeight = Math.max(MIN_SIZE, Math.min(initialHeight + deltaY, imgBottom - initialTop));
                        break;
                        
                    case 's': // í•˜ë‹¨ ì¤‘ì•™
                        // ë†’ì´ë§Œ ë³€ê²½ (ì•„ë˜ìª½)
                        newHeight = Math.max(MIN_SIZE, Math.min(initialHeight + deltaY, imgBottom - initialTop));
                        break;
                        
                    case 'sw': // ì¢Œí•˜ë‹¨
                        // ë„ˆë¹„ ë³€ê²½ (ì™¼ìª½ ë³€ê²½)
                        newLeft = Math.max(imgLeft, Math.min(initialLeft + deltaX, initialLeft + initialWidth - MIN_SIZE));
                        newWidth = initialWidth - (newLeft - initialLeft);
                        
                        // ë†’ì´ ë³€ê²½ (ì•„ë˜ìª½ ë³€ê²½)
                        newHeight = Math.max(MIN_SIZE, Math.min(initialHeight + deltaY, imgBottom - initialTop));
                        break;
                        
                    case 'w': // ì¢Œì¸¡ ì¤‘ì•™
                        // ë„ˆë¹„ë§Œ ë³€ê²½ (ì™¼ìª½)
                        newLeft = Math.max(imgLeft, Math.min(initialLeft + deltaX, initialLeft + initialWidth - MIN_SIZE));
                        newWidth = initialWidth - (newLeft - initialLeft);
                        break;
                }
                
                // í¬ë¡­ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
                cropBox.style.left = newLeft + 'px';
                cropBox.style.top = newTop + 'px';
                cropBox.style.width = newWidth + 'px';
                cropBox.style.height = newHeight + 'px';
                
                // ì‹¤ì‹œê°„ í¬ë¡­ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                updateCropPreview();
            }
            
            // í¬ê¸° ì¡°ì ˆ ì¢…ë£Œ
            function endResize() {
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', endResize);
                log('í¬ê¸° ì¡°ì ˆ ì¢…ë£Œ');
                
                // ìµœì¢… í¬ë¡­ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                updateCropPreview();
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', endResize);
        }

        // í¬ë¡­ ë°•ìŠ¤ ì´ë™ ì‹œì‘
        function startMove(e) {
            // í•¸ë“¤ì—ì„œì˜ ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ (ì´ë¯¸ í•¸ë“¤ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬ë¨)
            if (e.target.classList.contains('crop-handle')) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            log('í¬ë¡­ ë°•ìŠ¤ ì´ë™ ì‹œì‘');
            
            // í˜„ì¬ ìƒíƒœ ì €ì¥
            const initialCropBoxRect = cropBox.getBoundingClientRect();
            const initialMouseX = e.clientX;
            const initialMouseY = e.clientY;
            
            // ì´ë™ í•¨ìˆ˜
            function handleMove(moveEvent) {
                const deltaX = moveEvent.clientX - initialMouseX;
                const deltaY = moveEvent.clientY - initialMouseY;
                
                const containerRect = imageContainer.getBoundingClientRect();
                const imgRect = imageContainer.querySelector('img').getBoundingClientRect();
                
                // ì´ë¯¸ì§€ ë‚´ë¶€ ìœ„ì¹˜ ê³„ì‚°
                const imgLeft = imgRect.left - containerRect.left;
                const imgTop = imgRect.top - containerRect.top;
                const imgRight = imgLeft + imgRect.width;
                const imgBottom = imgTop + imgRect.height;
                
                // ìƒˆ ìœ„ì¹˜ ê³„ì‚° (ì´ë¯¸ì§€ ì˜ì—­ ë‚´ë¡œ ì œí•œ)
                let newLeft = Math.max(imgLeft, Math.min(initialCropBoxRect.left - containerRect.left + deltaX, imgRight - initialCropBoxRect.width));
                let newTop = Math.max(imgTop, Math.min(initialCropBoxRect.top - containerRect.top + deltaY, imgBottom - initialCropBoxRect.height));
                
                // í¬ë¡­ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
                cropBox.style.left = newLeft + 'px';
                cropBox.style.top = newTop + 'px';
                
                // ì‹¤ì‹œê°„ í¬ë¡­ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                updateCropPreview();
            }
            
            // ì´ë™ ì¢…ë£Œ
            function endMove() {
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('mouseup', endMove);
                log('í¬ë¡­ ë°•ìŠ¤ ì´ë™ ì¢…ë£Œ');
                
                // ìµœì¢… í¬ë¡­ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                updateCropPreview();
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', endMove);
        }

        // í¬ë¡­ í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
        function updateCropPreview() {
            if (!cropBox || !imageContainer || !originalImage) return;
            
            const img = imageContainer.querySelector('img');
            if (!img) return;
            
            // ì´ë¯¸ì§€ì™€ ì»¨í…Œì´ë„ˆì˜ ìœ„ì¹˜ ì •ë³´
            const imgRect = img.getBoundingClientRect();
            const containerRect = imageContainer.getBoundingClientRect();
            
            // í¬ë¡­ ë°•ìŠ¤ ìœ„ì¹˜ ë° í¬ê¸° (ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ê¸°ì¤€)
            const cropLeft = parseInt(cropBox.style.left);
            const cropTop = parseInt(cropBox.style.top);
            const cropWidth = parseInt(cropBox.style.width);
            const cropHeight = parseInt(cropBox.style.height);
            
            // ì´ë¯¸ì§€ ë‚´ì—ì„œì˜ ìƒëŒ€ì  ìœ„ì¹˜ ê³„ì‚°
            const imgLeft = imgRect.left - containerRect.left;
            const imgTop = imgRect.top - containerRect.top;
            
            // ìƒëŒ€ì  í¬ë¡­ ìœ„ì¹˜
            const relCropLeft = (cropLeft - imgLeft) / img.offsetWidth;
            const relCropTop = (cropTop - imgTop) / img.offsetHeight;
            const relCropWidth = cropWidth / img.offsetWidth;
            const relCropHeight = cropHeight / img.offsetHeight;
            
            // ìº”ë²„ìŠ¤ ìƒì„± ë° í¬ë¡­ ìˆ˜í–‰
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const tempImg = new Image();
            tempImg.src = originalImage;
            
            tempImg.onload = function() {
                // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ í¬ë¡­ ê³„ì‚°
                const srcX = Math.max(0, Math.floor(relCropLeft * tempImg.width));
                const srcY = Math.max(0, Math.floor(relCropTop * tempImg.height));
                const srcWidth = Math.min(tempImg.width - srcX, Math.floor(relCropWidth * tempImg.width));
                const srcHeight = Math.min(tempImg.height - srcY, Math.floor(relCropHeight * tempImg.height));
                
                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.width = srcWidth;
                canvas.height = srcHeight;
                
                // ì´ë¯¸ì§€ í¬ë¡­ ë° ê·¸ë¦¬ê¸°
                ctx.drawImage(
                    tempImg,
                    srcX, srcY, srcWidth, srcHeight,
                    0, 0, srcWidth, srcHeight
                );
                
                // í¬ë¡­ëœ ì´ë¯¸ì§€ URL ìƒì„±
                const croppedImageURL = canvas.toDataURL('image/png');
                
                // í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
                updatePreview(croppedImageURL);
            };
        }

        // í¬ë¡­ ì ìš© ë²„íŠ¼ í‘œì‹œ
        function showApplyButton() {
            log('í¬ë¡­ ì ìš© ë²„íŠ¼ í‘œì‹œ');
            
            // ê¸°ì¡´ ë²„íŠ¼ ìˆìœ¼ë©´ ì œê±°
            const existingBtn = document.querySelector('.apply-crop-btn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            // ë²„íŠ¼ ìƒì„±
            const applyBtn = document.createElement('button');
            applyBtn.className = 'apply-crop-btn';
            applyBtn.textContent = 'í¬ë¡­ ì ìš©í•˜ê¸°';
            
            // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆì— ë²„íŠ¼ ì¶”ê°€
            if (imageContainer) {
                imageContainer.appendChild(applyBtn);
            } else {
                log('ì˜¤ë¥˜: ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆê°€ ì—†ì–´ì„œ ë²„íŠ¼ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
            applyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                log('í¬ë¡­ ì ìš© ë²„íŠ¼ í´ë¦­ë¨');
                applyCrop();
            });
        }

        // ì´ë¯¸ì§€ í¬ë¡­ ë° ì ìš©
        function cropImage() {
            if (!cropBox || !imageContainer || !originalImage) {
                log('í¬ë¡­ ì‹¤íŒ¨: í•„ìš”í•œ ìš”ì†Œê°€ ì—†ìŒ');
                return;
            }
            
            const img = imageContainer.querySelector('img');
            if (!img) return;
            
            log('ì´ë¯¸ì§€ í¬ë¡­ ì‹œì‘');
            
            // ì´ë¯¸ì§€ì™€ ì»¨í…Œì´ë„ˆì˜ ìœ„ì¹˜ ì •ë³´
            const imgRect = img.getBoundingClientRect();
            const containerRect = imageContainer.getBoundingClientRect();
            
            // í¬ë¡­ ë°•ìŠ¤ ìœ„ì¹˜ ë° í¬ê¸° (ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ê¸°ì¤€)
            const cropLeft = parseInt(cropBox.style.left);
            const cropTop = parseInt(cropBox.style.top);
            const cropWidth = parseInt(cropBox.style.width);
            const cropHeight = parseInt(cropBox.style.height);
            
            log(`í¬ë¡­ ë°•ìŠ¤ ìœ„ì¹˜: left=${cropLeft}, top=${cropTop}, width=${cropWidth}, height=${cropHeight}`);
            
            // ì´ë¯¸ì§€ ë‚´ì—ì„œì˜ ìƒëŒ€ì  ìœ„ì¹˜ ê³„ì‚°
            const imgLeft = imgRect.left - containerRect.left;
            const imgTop = imgRect.top - containerRect.top;
            
            // ìƒëŒ€ì  í¬ë¡­ ìœ„ì¹˜
            const relCropLeft = (cropLeft - imgLeft) / img.offsetWidth;
            const relCropTop = (cropTop - imgTop) / img.offsetHeight;
            const relCropWidth = cropWidth / img.offsetWidth;
            const relCropHeight = cropHeight / img.offsetHeight;
            
            log(`ìƒëŒ€ì  í¬ë¡­ ìœ„ì¹˜: left=${relCropLeft.toFixed(3)}, top=${relCropTop.toFixed(3)}, width=${relCropWidth.toFixed(3)}, height=${relCropHeight.toFixed(3)}`);
            
            // ìº”ë²„ìŠ¤ ìƒì„± ë° í¬ë¡­ ìˆ˜í–‰
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const tempImg = new Image();
            tempImg.src = originalImage;
            
            tempImg.onload = function() {
                log(`ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°: ${tempImg.width}x${tempImg.height}`);
                
                // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ í¬ë¡­ ê³„ì‚°
                const srcX = Math.max(0, Math.floor(relCropLeft * tempImg.width));
                const srcY = Math.max(0, Math.floor(relCropTop * tempImg.height));
                const srcWidth = Math.min(tempImg.width - srcX, Math.floor(relCropWidth * tempImg.width));
                const srcHeight = Math.min(tempImg.height - srcY, Math.floor(relCropHeight * tempImg.height));
                
                log(`í¬ë¡­ ì˜ì—­ ê³„ì‚°: x=${srcX}, y=${srcY}, width=${srcWidth}, height=${srcHeight}`);
                
                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.width = srcWidth;
                canvas.height = srcHeight;
                
                // ì´ë¯¸ì§€ í¬ë¡­ ë° ê·¸ë¦¬ê¸°
                ctx.drawImage(
                    tempImg,
                    srcX, srcY, srcWidth, srcHeight,
                    0, 0, srcWidth, srcHeight
                );
                
                // í¬ë¡­ëœ ì´ë¯¸ì§€ URL ìƒì„±
                const croppedImageURL = canvas.toDataURL('image/png');
                
                log('í¬ë¡­ ì™„ë£Œ, ì´ë¯¸ì§€ URL ìƒì„±ë¨');
                
                // ì›ë³¸ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                originalImage = croppedImageURL;
                
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
                setupImageCropper(croppedImageURL);
            };
        }

        // í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
        function updatePreview(imageURL) {
            log('í”„ë¦¬ë·° ì—…ë°ì´íŠ¸');
            const previewBox = document.getElementById('preview-box');
            if (previewBox) {
                previewBox.innerHTML = '';
                const img = document.createElement('img');
                img.src = imageURL;
                previewBox.appendChild(img);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œì— ì ìš© ë²„íŠ¼ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì´í›„...
            
            // ì´ˆê¸° ì ìš© ë²„íŠ¼ í‘œì‹œ
            setTimeout(() => {
                if (imageContainer) {
                    showApplyButton();
                }
            }, 500);
        });

        // í¬ë¡­ ì‹œì‘ (ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸)
        function startCrop(e) {
            e.preventDefault();
            log('í¬ë¡­ ì‹œì‘ (mousedown)');
            
            // ì´ë¯¸ì§€ ì˜ì—­ ë‚´ì—ì„œë§Œ í¬ë¡­ ê°€ëŠ¥í•˜ë„ë¡
            const img = imageContainer.querySelector('img');
            if (!img) return;
            
            const imgRect = img.getBoundingClientRect();
            const containerRect = imageContainer.getBoundingClientRect();
            
            // ë§ˆìš°ìŠ¤ í¬ì§€ì…˜ ê³„ì‚° (ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ê¸°ì¤€)
            const mouseX = e.clientX - containerRect.left;
            const mouseY = e.clientY - containerRect.top;
            
            log(`ë§ˆìš°ìŠ¤ ìœ„ì¹˜: x=${mouseX}, y=${mouseY}`);
            
            // í¬ë¡­ ì‹œì‘ ìœ„ì¹˜ ì €ì¥
            cropStartX = mouseX;
            cropStartY = mouseY;
            
            // ì´ë¯¸ ìˆëŠ” í¬ë¡­ ë°•ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
            if (cropBox) {
                cropBox.remove();
            }
            
            // ìƒˆ í¬ë¡­ ë°•ìŠ¤ ìƒì„±
            cropBox = document.createElement('div');
            cropBox.className = 'crop-box';
            cropBox.style.position = 'absolute';
            cropBox.style.border = '3px dashed var(--accent-color)';
            cropBox.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
            cropBox.style.zIndex = '10';
            cropBox.style.borderRadius = 'var(--border-radius)';
            cropBox.style.left = cropStartX + 'px';
            cropBox.style.top = cropStartY + 'px';
            cropBox.style.width = '0px';
            cropBox.style.height = '0px';
            cropBox.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.3)';
            
            imageContainer.appendChild(cropBox);
            
            // í¬ë¡­ í™œì„±í™” ìƒíƒœ ì„¤ì •
            cropperActive = true;
            
            // mousemoveì™€ mouseup ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('mousemove', handleNewCrop);
            document.addEventListener('mouseup', endNewCrop);
        }

        // ìƒˆ í¬ë¡­ ì˜ì—­ í•¸ë“¤ë§ (ë§ˆìš°ìŠ¤ ë¬´ë¸Œ ì´ë²¤íŠ¸)
        function handleNewCrop(e) {
            if (!cropperActive || !cropBox || !imageContainer) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const containerRect = imageContainer.getBoundingClientRect();
            const img = imageContainer.querySelector('img');
            if (!img) return;
            
            const imgRect = img.getBoundingClientRect();
            
            // ì´ë¯¸ì§€ ë‚´ë¶€ ìœ„ì¹˜ ê³„ì‚°
            const imgLeft = imgRect.left - containerRect.left;
            const imgTop = imgRect.top - containerRect.top;
            const imgRight = imgLeft + imgRect.width;
            const imgBottom = imgTop + imgRect.height;
            
            // ë§ˆìš°ìŠ¤ í¬ì§€ì…˜ ê³„ì‚° (ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ê¸°ì¤€)
            let mouseX = e.clientX - containerRect.left;
            let mouseY = e.clientY - containerRect.top;
            
            // ì´ë¯¸ì§€ ì˜ì—­ ë‚´ë¡œ ì œí•œ
            mouseX = Math.max(imgLeft, Math.min(mouseX, imgRight));
            mouseY = Math.max(imgTop, Math.min(mouseY, imgBottom));
            
            // í¬ë¡­ ë°•ìŠ¤ í¬ê¸° ë° ìœ„ì¹˜ ê³„ì‚°
            const width = Math.abs(mouseX - cropStartX);
            const height = Math.abs(mouseY - cropStartY);
            const left = Math.min(cropStartX, mouseX);
            const top = Math.min(cropStartY, mouseY);
            
            // í¬ë¡­ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
            if (width > 0 && height > 0) {
                cropBox.style.width = width + 'px';
                cropBox.style.height = height + 'px';
                cropBox.style.left = left + 'px';
                cropBox.style.top = top + 'px';
            }
            
            // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì˜ì—­ì´ ì¶©ë¶„íˆ í´ ë•Œë§Œ)
            if (width > 20 && height > 20) {
                updateCropPreview();
            }
        }

        // ìƒˆ í¬ë¡­ ì¢…ë£Œ (ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸)
        function endNewCrop() {
            if (!cropperActive || !cropBox || !imageContainer) return;
            
            log('í¬ë¡­ ì¢…ë£Œ (mouseup)');
            
            // í¬ë¡­ ì˜ì—­ì´ ë„ˆë¬´ ì‘ìœ¼ë©´ ë¬´ì‹œ
            const width = parseInt(cropBox.style.width);
            const height = parseInt(cropBox.style.height);
            
            // ìµœì†Œ í¬ê¸° ì œí•œ (10px)
            const MIN_CROP_SIZE = 10;
            
            if (width < MIN_CROP_SIZE || height < MIN_CROP_SIZE) {
                log(`í¬ë¡­ ì˜ì—­ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. í¬ê¸°: ${width}x${height}, ìµœì†Œ í¬ê¸°: ${MIN_CROP_SIZE}x${MIN_CROP_SIZE}`);
                cropBox.remove();
                cropBox = null;
                
                // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°ì˜ í¬ë¡­ ë°•ìŠ¤ ë‹¤ì‹œ ìƒì„±
                const img = imageContainer.querySelector('img');
                if (img) {
                    const imgRect = img.getBoundingClientRect();
                    const containerRect = imageContainer.getBoundingClientRect();
                    const imgLeft = imgRect.left - containerRect.left;
                    const imgTop = imgRect.top - containerRect.top;
                    
                    createInitialCropBox(imgLeft, imgTop, imgRect.width, imgRect.height);
                }
            } else {
                // ì„±ê³µì ì¸ í¬ë¡­ - í•¸ë“¤ ì¶”ê°€
                addCropHandles(cropBox);
                
                // í¬ë¡­ ë°•ìŠ¤ì— ì´ë™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                cropBox.addEventListener('mousedown', startMove);
                
                // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                updateCropPreview();
            }
            
            // í¬ë¡­ ìƒíƒœ ì´ˆê¸°í™”
            cropperActive = false;
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.removeEventListener('mousemove', handleNewCrop);
            document.removeEventListener('mouseup', endNewCrop);
            
            // ì ìš© ë²„íŠ¼ í‘œì‹œ
            showApplyButton();
        }

        // applyCrop í•¨ìˆ˜ ì¶”ê°€
        function applyCrop() {
            log('í¬ë¡­ ì ìš© ì‹œì‘');
            
            if (!cropBox || !imageContainer || !originalImage) {
                log('í¬ë¡­ ì‹¤íŒ¨: í•„ìš”í•œ ìš”ì†Œê°€ ì—†ìŒ');
                return;
            }
            
            // í˜„ì¬ í¬ë¡­ ì˜ì—­ìœ¼ë¡œ ì´ë¯¸ì§€ ìë¥´ê¸°
            cropImage();
            
            // ì„±ê³µ ë©”ì‹œì§€
            log('í¬ë¡­ì´ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    </script>
</body>
</html> 